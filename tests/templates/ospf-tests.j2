*** Settings ***
Library       pyats.robot.pyATSRobot
Library       unicon.robot.UniconRobot
Library       genie.libs.robot.GenieRobot
Library       Collections

Force Tags    robot:continue-on-failure         # ensure test cases continue on failure
Suite Setup   setup

*** Variables ***
${testbed}       ./testbed.yaml

*** Test Cases ***

{% for device in devices %}
Check OSPF interface state on device {{ device.name }}
    ${result}=  parse "show ip ospf neighbor detail" on device "{{ device.name }}"
    Log Dictionary   ${result}
    ${interfaces}=  dq query  data=${result}  filters=get_values('interfaces')
    Log   ${interfaces}
    {% for ospf_int in device.params.ospf_interfaces %}
    List Should Contain Value   ${interfaces}   {{ ospf_int.name }}   msg=OSPF interface {{ ospf_int.name }} has no neighbors
    {% endfor %}

Check loopback routes on device {{ device.name }}
    @{loopbacks}=   Create List   1.1.1.1   {% for d in devices %}{{d.params.ipv4_loopback}}    {% endfor %}
    FOR  ${r}   IN   @{loopbacks}
        ${result}=  parse "show ip route ${r}" on device "{{ device.name }}"
        Log    ${result}
        Should be True    len($result['entry'].get('${r}/32', []) > 0    msg=route ${r}/32 not found
    END
{% endfor %}


*** Keywords ***
setup
    use testbed "${testbed}"
{% for device in devices %}
    connect to device "{{ device.name }}"
{% endfor %}
